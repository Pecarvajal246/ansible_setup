---
- hosts: localhost
  connection: local
  become: true

  pre_tasks:
    - name: Update repos
      dnf:
        update_cache: yes
      when: ansible_distribution == 'Fedora'

    - name: Update packages
      dnf:
        name: "*"
        state: latest
      when: ansible_distribution == 'Fedora'

  tasks:
    - name: Enable the RPM Fusion repository
      dnf:
        name:
          - "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ansible_distribution_major_version}}.noarch.rpm"
          - "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ansible_distribution_major_version}}.noarch.rpm"
        state: present
        disable_gpg_check: True
      when: ansible_distribution == 'Fedora'

    - name: Enable iosevka CORPS
      community.general.copr:
        state: enabled
        name: peterwu/iosevka
      when: ansible_distribution == 'Fedora'

    - name: Enable qtile CORPS
      community.general.copr:
        state: enabled
        name: frostyx/qtile
      when: ansible_distribution == 'Fedora'

    - name: install packages
      package:
        name:
          - stow
          - gcc-c++
          - rofi
          - awesome
          - mpv
          - mpd
          - mpdris2
          - ncmpcpp
          - dunst
          - sxhkd
          - picom
          - kitty
          - fish
          - xclip
          - playerctl
          - iosevka-fonts
          - neovim
          - qtile
          - fzf
          - alacritty
          - python3-pip

    - name: python packages
      pip:
        name:
          - dbus-next

    - name: install pipx
      pip:
        name: pipx
        extra_args: --user

    - name: install streamlink
      community.general.pipx:
        name: streamlink

    - name: install yt-dlp
      community.general.pipx:
        name: yt-dlp

    - name: install twofi
      community.general.pipx:
        name: twofi
        source: git+https://github.com/Pecarvajal246/twofi

    - name: dotfiles
      become_user: pedro
      git:
        repo: https://github.com/Pecarvajal246/.dotfiles.git
        dest: /home/pedro/.dotfiles/
        clone: yes

    - name: remove old bashrc
      file:
        path: /home/pedro/.bashrc
        state: absent

    - name: remove old profile
      file:
        path: /home/pedro/.profile
        state: absent

    - name: stow dotfiles
      shell:
        chdir: /home/pedro/.dotfiles/
        cmd: stow --restow *

    - name: copy scripts
      copy:
        src: scripts/
        dest: /home/pedro/.local/bin/
        directory_mode: a+x
        mode: a+x
        owner: pedro
